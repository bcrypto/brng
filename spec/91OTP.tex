\providecommand\Name{\text{Name}\xspace}

\begin{appendix}{А}{рекомендуемое}{Одноразовые пароли}
\label{OTP}

\hiddensection{Назначение}

Одноразовые пароли предназначены для усиления аутентификации в клиент-серверных системах:
кроме обычного долговременного (статического) пароля клиент 
предъявляет серверу дополнительный пароль, срок действия которого ограничен определенным 
сеансом аутентификации или промежутком времени. Даже если противник узнает 
пароль текущего сеанса или промежутка, он не сможет использовать его в следующем.

Аутентификация может быть двусторонней:
после успешной аутентификации клиента сервер 
генерирует новый одноразовый пароль и предъявляет его клиенту. 

\hiddensection{Режимы}

Стороны генерируют одноразовый пароль~$R$,
комбинируя общий секретный ключ~$K$ с уникальной синхропосылкой.
Ключ~$K$ должен удовлетворять требованиям~\ref{COMMON.Key}.

В зависимости от способа формирования синхропосылки определены
три режима (механизма) генерации паролей: 
HOTP (HMAC-based One-Time Password), 
TOTP (Time-based One-Time Password) и 
OCRA (OATH Challenge-Response Algorithms).
Названия режимов соответствуют спецификациям~\cite{HOTP}~--- \cite{OCRA}.

В режиме HOTP синхропосылка представляет собой счетчик~$C$,
который инкрементируется (увеличивается на~$1$) 
всякий раз после выработки пароля клиентом или его успешной 
проверки сервером. 
%
Обновленный счетчик может использоваться для генерации или 
проверки нового пароля.
%
Используются младшие 64 бита двоичной записи~$C$,
и поэтому операции с ним можно вести по модулю~$2^{64}$.

В режиме TOTP синхропосылка представляет собой  
округленную отметку текущего времени. Текущее время~--- это количество полных 
секунд, прошедших с 0~ч 1~января 1970~года в стандартном времени по Гринвичу
(без учета секунды координации). 
%
Округление~$T$ выполняется с параметрами~$T_0$ и~$T_s$,
где~$T_0$--- базовая отметка времени, неотрицательное целое число, 
$T_s$~--- шаг времени, натуральное число. 
%
Должно выполняться ограничение: $T_0\leq T$.
%
Округление состоит в замене~$T$ на $\lfloor(T-T_0)/T_s\rfloor$.
%
Рекомендуется выбирать~$T_0=0$ и использовать шаг~$T_s=30$, 
т.~е. менять пароль каждые 30~с,
или~$T_s=60$, т.~е. менять пароль каждую минуту.

Округленная отметка~$T$, а вместе с ней и одноразовый пароль
остаются постоянными во временном окне длины~$T_s$.
Поэтому сервер не должен принимать пароль клиента 
дважды в одном окне. 

Режим OCRA является универсальным:
его синхропосылка может включать и счетчик~$C$, и округленную 
отметку времени~$T$. Правила HOTP для счетчика
и правила TOTP для меток времени переносятся в режим OCRA.

Кроме~$C$ и~$T$, синхропосылка OCRA обязательно содержит запрос~$Q$ 
противоположной стороны, возможно дополненный собственным
запросом. 
%
Запросы должны генерироваться случайным или псевдослучайным образом.
%
Синхропосылка режима OCRA может дополнительно включать 
хэш-значение~$P$ долговременного пароля клиента
и идентификатор~$S$ сеанса между клиентом и сервером.

Одноразовый пароль может генерироваться специальным аппаратным 
устройством (токеном) и отображаться на дисплее устройства.
%
При использовании механизма HOTP устройство должно быть снабжено
перезаписываемой памятью для хранения счетчика,
при использовании механизма TOTP~--- таймером,
при использовании механизма OCRA~--- 
устройством ввода запроса.

Ввиду ограниченности возможностей ввода 
запросы OCRA представляют собой строки в одном из трех алфавитов,
полученных сужением множества символов таблицы~\ref{Table.ASCII}:
\begin{align*}
A&=\{
\texttt{0},\texttt{1},\ldots,\texttt{9},
\texttt{A},\texttt{B},\ldots,\texttt{Z}\},\\
N&=\{
\texttt{0},\texttt{1},\ldots,\texttt{9}\},\\
H&=\{
\texttt{0},\texttt{1},\ldots,\texttt{9},
\texttt{A},\texttt{B},\ldots,\texttt{F}\}.
\end{align*}

Первый алфавит~--- буквенно-цифровой,
второй~--- цифровой, третий~--- шестнадцатеричный.

\hiddensection{Пароль}

Одноразовый пароль представляет собой число из $d$ десятичных цифр
(включая незначащие старшие нули).
%
В режимах HOTP и TOTP длина~$d$ должна принимать значения~$6$, $7$ или~$8$.
В режиме OCRA дополнительно разрешены~$d\in\{4,5,9\}$. 

Пароль минимальной длины~$d=4$ рекомендуется применять 
только в особых случаях~--- тогда, когда пароль другой длины 
использовать нельзя.

\hiddensection{Вспомогательные алгоритмы}

Используется функция хэширования~$h$,
удовлетворяющая ограничениям HMAC (пункт~\ref{COMMON.Hash}).
Длина хэш-значений не должна быть меньше~$160$.
%
Функция~$h$ применяется косвенно~--- как композиционный элемент
алгоритма~$\HMAC[h]$.

Имитовставки~$\HMAC[h]$ обрабатываются вспомогательным 
алгоритмом~\texttt{otp-dt}, определенным в~\ref{OTP.DT}.

Для использования в режиме OCRA
алгоритм хэширования должен описываться уникальной строкой
$\Name(h)$ символов таблицы~\ref{Table.ASCII}. 
%
Строка $\Name(h)$ должна полностью определять действие~$h$.
Недопустимы ситуации, когда для описания действия, 
кроме~$\Name(h)$, требуется указывать дополнительные параметры, 
например начальное хэш-значение.

Функции хэширования СТБ 34.101.31 назначается имя 
\texttt{"HBELT"}.

%\doubt{\texttt{"SHA1"}, \texttt{"SHA256"}, \texttt{"SHA512"}.}

\hiddensection{Синхронизация и блокировка}

В режиме HOTP счетчики клиента и сервера могут разойтись.
Это произойдет например тогда, когда клиент ошибочно сгенерировал 
несколько паролей вместо одного, и ни один из них не отослал серверу. 
Даже в этом случае сервер может восстановить синхронизацию. 
Сервер выполняет алгоритм генерации паролей~$s$ раз, 
каждый раз инкрементируя счетчик и сравнивая построенный пароль 
с присланным клиентом. Вычисления заканчиваются как только 
совпадение паролей будет обнаружено. При этом окончательный счетчик 
сервера с большой достоверностью совпадет со счетчиком клиента.
%
Если же ни один из~$s$ построенных паролей не подошел, 
то сервер принимает решение об ошибке аутентификации
и возвращается к своему первоначальному счетчику.

Сервер может блокировать клиента после $v$ неудачных попыток аутентификации. 
Блокировка может быть временной или постоянной.

При проектировании системы аутентификации 
и выборе параметров $d$, $s$ и $v$ следует учитывать, 
что вероятность успешной аутентификации противником,
который предъявляет случайный пароль, близка к
${sv}/{10^d}$.
%
Среди~$s$ и~$v$, сохраняющих удобство использования системы аутентификации, 
рекомендуется выбирать минимальные.

В режиме TOTP могут разойтись показания таймеров клиента и сервера.
Сервер может обработать ошибку аутентификации, увеличивая (уменьшая) 
округленную отметку времени $s_{1}$ ($s_{-1}$) раз на~$1$,
каждый раз генерируя новый пароль и сравнивая его с присланным 
клиентом. Таким образом можно подавить разность в округленных показаниях
таймеров клиента и сервера, если она лежит в интервале~$[-s_{-1},s_1]$.
%
После совпадения паролей сервер может оценить расхождение
таймеров и учитывать его в дальнейших сеансах с данным клиентом.

Правила настройки параметров аутентификации на основе паролей 
TOTP повторяют правила HOTP с заменой~$s$ на~$s_{-1}+s_1+1$.

\hiddensection{Построение пароля по имитовставке}
\label{OTP.DT}

\subsection{Входные и выходные данные}

Входными данными алгоритма~\texttt{otp-dt} является 
количество~$d\in\{4,5,\ldots,9\}$ цифр в пароле и 
имитовставка~$Y\in\{0,1\}^{2l}$. 
Имитовставка разбивается на~$n=|Y|/8$ октетов:
$$
Y=Y_0\parallel Y_1\parallel\ldots\parallel Y_{n-1},\quad
Y_i\in\{0,1\}^8.
$$

Выходными данными является одноразовый пароль~$R\in\{0,1,\ldots,10^d-1\}$.

\subsection{Переменные}

Используются переменные~$t\in\{0,1,\ldots,15\}$ и $r\in\{0,1,\ldots,2^{32}-1\}$.

\subsection{Алгоритм}

Построение пароля состоит в выполнении следующих шагов:
\begin{enumerate}
\item
$t\leftarrow \bar{Y}_{n-1}\bmod 16$.

\item
$r\leftarrow \bar{Y}_t 2^{24}+\bar{Y}_{t+1} 2^{16}+
\bar{Y}_{t+2}2^{8}+\bar{Y}_{t+3}$.

\item
$r\leftarrow r\bmod 2^{31}$.

\item
$R\leftarrow r\bmod 10^d$.

\item
Возвратить $R$.
\end{enumerate}

\hiddensection{Генерация пароля в режиме HOTP}
\label{OTP.HOTP}

\subsection{Входные и выходные данные}

Входными данными алгоритма генерации одноразовых паролей
в режиме HOTP являются 
количество~$d\in\{6,7,8\}$ цифр в пароле,
секретный ключ~$K\in\{0,1\}^{8*}$
и счетчик~$C$~--- неотрицательное целое число.

Выходными данными является одноразовый пароль~$R\in\{0,1,\ldots,10^d-1\}$.

\subsection{Переменные}

Используются переменные~$Y\in\{0,1\}^{2l}$ и~$W\in\{0,1\}^{64}$.
Значение~$Y$ должно быть уничтожено после использования.
%
Переменная~$W$ разбивается на $8$ октетов:
$$
W=W_0\parallel W_1\parallel\ldots\parallel W_7,\quad
W_i\in\{0,1\}^8.
$$

\subsection{Алгоритм}

Генерация пароля в режиме НОТР состоит в выполнении следующих шагов:
\begin{enumerate}
\item
$W\leftarrow\langle C\rangle_{64}$.

\item
$Y\leftarrow\HMAC[h](K,W_7\parallel W_6\parallel\ldots\parallel W_0)$.

\item
$R\leftarrow\texttt{otp-dt}(d, Y)$.

\item
Возвратить $R$.
\end{enumerate}

\hiddensection{Генерация пароля в режиме TOTP}
\label{OTP.TOTP}

\subsection{Входные и выходные данные}

Входными данными алгоритма генерации одноразовых паролей
в режиме TOTP являются 
количество~$d\in\{6,7,8\}$ цифр в пароле,
секретный ключ~$K\in\{0,1\}^{8*}$ и округленная отметка~$T$ текущего 
времени~--- неотрицательное целое число.

Выходными данными является одноразовый пароль~$R\in\{0,1,\ldots,10^d-1\}$.

\subsection{Алгоритм}

Генерация пароля в режиме TОТР повторяет генерацию в режиме HOTP
с заменой~$C$ на~$T$.

\hiddensection{Генерация пароля в режиме OCRA}
\label{OTP.OCRA}

\subsection{Входные данные}

Входными данными алгоритма генерации одноразовых паролей
в режиме OCRA являются:
\begin{itemize}
\item[1)]
количество~$d\in\{4,5,\ldots,9\}$ цифр в пароле;

\item[2)]
секретный ключ~$K\in\{0,1\}^{8*}$;

\item[3)]
счетчик~$C$~--- неотрицательное целое число;

\item[4)]
запрос (ы)~$Q\in\{0,1\}^{8*}$.
Октеты~$Q$ должны одновременно принадлежать одному из трех алфавитов:
$A$, $N$ или~$H$. 
%
Слово~$Q$ содержит запрос противоположной стороны,
возможно дополненный собственным запросом.
%
Каждый из запросов должен состоять из целого числа 
октетов: от~$4$ до~$64$. Рекомендуется использовать 
запрос из~$8$ символов-цифр алфавита~$N$;

\item[5)]
округленная отметка~$T$ текущего времени~--- неотрицательное целое число. 
Округление~$T$ должно выполняться с базовой отметкой $T_0=0$ 
и шагом~$T_s$, задаваемым целым числом секунд, минут или часов.
Рекомендуется использовать шаг в 1 мин;

\item[6)]
Хэш-значение~$P$ статического пароля~клиента.
Хэш-значение должно вычисляться с помощью функции~$h_1$,
которая совпадает с~$h$ или отличается от нее.
%\doubt{Длина значений~$h_1$ не должна превосходить~$256$.}
Функции~$h_1$ должно быть назначено имя $\Name(h_1)$;

\item[7)]
идентификатор~$S\in\{0,1\}^{8*}$ сеанса между клиентом и сервером.
Длина~$S$ в октетах не должна превышать~$512$.
Рекомендуется использовать идентификаторы из~$64$ октетов.
\end{itemize}

Параметры $C$, $T$, $P$, $S$ являются необязательными, 
они могут не подаваться на вход алгоритма.

\subsection{Описатель}

Перечень используемых входных параметров и их форматы задаются 
строковым описателем~$D$, который также подается на вход алгоритма.
%
Описатель имеет следующий вид:
$$
D=\texttt{\textquotedbl 
OCRA-1:HOTP-h-d:[C-]Qfq[-Pp][-Ss][-Ttg]\textquotedbl}.
$$

Квадратные скобки окаймляют часть строки, которая может быть 
исключена (вместе со скобками).
Наличие в описателе символа \texttt{C} означает включение в состав входных данных 
счетчика, наличие символа~\texttt{P}~--- хэш-значения пароля,
\texttt{S}~--- идентификатора сеанса, \texttt{T}~---
округленной отметки времени.

Строчные символы-буквы описателя переопределяются по следующим правилам:
%
\begin{itemize}
\item[1)]
символ~\texttt{h} меняется на строку~$\Name(h)$;
\item[2)]
символ~\texttt{d} меняется на цифру из 
множества~$\{\texttt{4},\texttt{5},\ldots,\texttt{9}\}$,  
представляющую число~$d$;
\item[3)]
символ~\texttt{f} меняется на код алфавита~$Q$:
\texttt{A}, если используется алфавит~$A$, 
\texttt{N}, если~--- алфавит~$N$, и \texttt{H}, если~---~$H$;
\item[4)]
символ~\texttt{q} меняется на строку из множества 
$\{\texttt{\textquotedbl 04\textquotedbl},
\texttt{\textquotedbl 05\textquotedbl},\ldots,
\texttt{\textquotedbl 64\textquotedbl}\}$,
представляющую максимальную длину запроса в октетах;
\item[5)]
символ~\texttt{p} меняется на строку~$\Name(h_1)$;
\item[6)]
символ~\texttt{s} меняется на строку из множества
$\{\texttt{\textquotedbl 001\textquotedbl},
\texttt{\textquotedbl 002\textquotedbl},\ldots,
\texttt{\textquotedbl 512\textquotedbl}\}$,
представляющую длину~$S$ в октетах;
\item[7)]
символ~\texttt{g} меняется на код единиц шага времени:
\texttt{S}, если шаг времени измеряется в секундах, 
\texttt{M}, если~--- в минутах, и \texttt{H}, если~--- в часах;
\item[8)]
символ~\texttt{t} меняется на строку,
представляющую шаг времени:
элемент множества 
$\{\texttt{\textquotedbl 1\textquotedbl},
\texttt{\textquotedbl 2\textquotedbl},\ldots,
\texttt{\textquotedbl 59\textquotedbl}\}$,
если шаг времени измеряется в секундах или минутах,
или множества $\{\texttt{\textquotedbl 1\textquotedbl},
\texttt{\textquotedbl 2\textquotedbl},\ldots,
\texttt{\textquotedbl 48\textquotedbl}\}$,
если шаг времени измеряется в часах.
\end{itemize}

\subsection{Выходные данные}

Выходными данными является одноразовый пароль~$R\in\{0,1,\ldots,10^d-1\}$.

\subsection{Переменные}

Используются переменные~$X\in\{0,1\}^{64}$, $Y\in\{0,1\}^{2l}$ 
и $W\in\{0,1\}^{64}$. 
%
Значение~$Y$ должно быть уничтожено после использования.
%
Переменная~$W$ разбивается на $8$ октетов:
$$
W=W_0\parallel W_1\parallel\ldots\parallel W_7,\quad
W_i\in\{0,1\}^8.
$$

\subsection{Алгоритм}

Генерация пароля в режиме OCRA состоит в выполнении следующих шагов:
\begin{enumerate}
\item
$X\leftarrow D\parallel\hex{00}$.

\item
Если счетчик~$C$ подан на вход, то
\begin{enumerate}
\item
$W\leftarrow\langle C\rangle_{64}$;

\item
$X\leftarrow X\parallel W_7\parallel W_6\parallel\ldots\parallel W_0$.
\end{enumerate}

\item
$X\leftarrow X\parallel Q\parallel 0^{1024-|Q|}$.

\item
Если хэш-значение~$P$ подано на вход, 
то~$X\leftarrow X\parallel P$.

\item
Если идентификатор~$S$ подан на вход, 
то~$X\leftarrow X\parallel S$.

\item
Если отметка~$T$ подана на вход, то
\begin{enumerate}
\item
$W\leftarrow\langle T\rangle_{64}$;

\item
$X\leftarrow X\parallel W_7\parallel W_6\parallel\ldots\parallel W_0$.
\end{enumerate}

\item
$Y\leftarrow\HMAC[h](K,X)$.

\item
$R\leftarrow\texttt{otp-dt}(d, Y)$.

\item
Возвратить $R$.
\end{enumerate}

\subsection{Аутентификация в режиме OCRA}\label{OTP.Auth}

Одноразовые пароли OCRA могут использоваться как для
односторонней, так и взаимной аутентификации сторон.

Протокол односторонней аутентификации:
\begin{enumerate}
\item 
Сервер формирует запрос~$Q$ и отправляет его клиенту.

\item 
Клиент по запросу~$Q$ генерирует одноразовый пароль~$R$
и отправляет его серверу.

\item 
Сервер по запросу~$Q$ генерирует 
одноразовый пароль и сравнивает его с~$R$.
\end{enumerate}

Успешное выполнение всех шагов протокола означает 
успешную аутентификацию клиента перед сервером.
%
При генерации~$R$ кроме запроса~$Q$ 
может дополнительно использоваться любой заранее 
согласованный набор необязательных параметров~$C$, $P$, $S$ и~$T$.

Протокол взаимной аутентификации:
\begin{enumerate}
\item  
Клиент формирует запрос~$Q_C$ и отправляет его серверу.

\item 
Сервер формирует запрос~$Q_S$,
по~$Q=Q_C \parallel Q_S$ генерирует одноразовый пароль~$R_S$
и отправляет клиенту~$Q_S$ и~$R_S$.

\item 
Клиент по запросам~$Q=Q_C \parallel Q_S$ генерирует 
одноразовый пароль и сравнивает его с~$R_S$,
затем по запросам~$Q'=Q_S \parallel Q_C$ генерирует
одноразовый пароль~$R_C$ и отправляет его серверу.

\item 
Сервер по запроcам~$Q'=Q_S \parallel Q_C$ генерирует 
одноразовый пароль и сравнивает его с~$R_C$.
\end{enumerate}

Успешное выполнение всех шагов протокола означает 
успешную взаимную аутентификацию сторон.
При генерации~$R_S$ кроме запросов
может дополнительно использоваться любой заранее согласованный 
набор необязательных параметров~$C$, $S$ и~$T$, 
а при генерации~$R_C$~---  любой заранее согласованный 
набор необязательных параметров~$C$, $P$, $S$ и~$T$.


\end{appendix}
